-if flash[:success] || flash[:error] || flash[:warning]
  =render partial: 'layouts/flash_messages'
.l-section-small.is-bg-asphalt
  .l-wrap
    .container-fluid
      .row.l-margin-bottom
        .col-md-12.text-center
          %h1.l-margin-bottom.l-margin-top.text-center.h-separator.h-separator-center{style: 'letter-spacing:1.5px;'}
            =t('views.users.show.h1')
      .row.l-margin-bottom
        .col-md-12{role: 'tablist'}
          .account-tab
            %a{href: '#personal-details', aria: {controls: 'in-progress'}, role: 'tab', data: {toggle: 'tab'}}=t('views.users.show.tabs.personal_details')
            -if @current_subscription
              %a{href: '#subscriptions', aria: {controls: 'completed'}, role: 'tab', data: {toggle: 'tab'}}=t('views.users.show.tabs.subscriptions')

      .row
        .l-margin-top-big
          .l-margin-bottom
            =form_for(@user, html: {class: 'form-horizontal', role: 'form'}) do |f|
              .tab-content
                .tab-pane.fade.in.active#personal-details{role: 'tabpanel'}
                  .row
                    .col-md-8.col-md-offset-2{style: 'padding-bottom: 50px;'}
                      =render partial: 'users/form_personal_details', locals: {f: f}
                -if @current_subscription
                  .tab-pane.fade#subscriptions{role: 'tabpanel'}
                    .row
                      .col-md-12
                        %h2.h2.l-margin-bottom.text-center
                          =t('views.users.show.your_subscription')

                        -if @current_subscription && !@current_subscription.free_trial?
                          .row
                            .col-sm-10.col-sm-offset-1.l-margin-top-big.l-margin-bottom-big
                              .col-sm-6
                                .row.l-margin-bottom-big{style: 'margin-left: 10px;'}
                                  %h4
                                    ="Memeber since: "
                                    &nbsp;
                                    =humanize_datetime(@user.created_at)
                                  %br/
                                  %h4
                                    -last_invoice = @user.invoices.all_in_order.last
                                    ="Last Payment: "
                                    &nbsp;
                                    =number_in_local_currency(last_invoice.total, last_invoice.currency_id)
                                    =" on "
                                    =humanize_datetime(last_invoice.created_at)
                                  %br/
                                  %h4
                                    =t('views.users.show.your_next_payment_will_be_on')
                                    &nbsp;
                                    =@current_subscription.next_renewal_date
                                  %br/
                                  %h4
                                    ="Billing Interval: "
                                    &nbsp;
                                    =t("views.general.payment_frequency_in_months.a#{@current_subscription.subscription_plan.payment_frequency_in_months}")

                                  -unless @current_subscription.current_status == 'active'
                                    %h3
                                      =t('views.users.show.your_plans_current_status')
                                      ="#{@current_subscription.current_status}."
                                      %br/
                                      -if @current_subscription.current_status == 'canceled'
                                        =t('views.users.show.your_plan_expired_on')
                                      -elsif @current_subscription.current_status == 'canceled-pending'
                                        =t('views.users.show.your_plan_will_expire_on')

                              .col-sm-6
                                -if @current_subscription.current_status == 'canceled'
                                  %h3=t('views.users.show.reactivate_subscription.h3')
                                  =link_to t('views.users.show.reactivate_subscription.button_call_to_action'), '#', class: 'btn btn-red l-margin-right-big l-padding-side-3x l-margin-top', data: {toggle: 'modal', target: '#re-subscribe-modal'}
                                -elsif @current_subscription.current_status == 'canceled-pending'
                                  %h3=t('views.users.show.un_cancel_subscription.h3')
                                  =link_to t('views.users.show.un_cancel_subscription.button_call_to_action'), subscription_url(id: @current_subscription.id, subscription: {subscription_plan_id: 123}), method: :put, class: 'btn btn-red l-margin-top'


                                -else
                                  .row
                                    .col-sm-10.col-md-offset-2
                                      =link_to t('views.users.show.upgrade_subscription_plan'), '#', class: 'btn btn-purple  l-margin-bottom', data: {toggle: 'modal', target: '#upgrade-subscription-modal'}
                                      -#=link_to t('views.users.show.add_new_card'), '#', data: {toggle: 'modal', target: '#new-subscription-payment-card-modal'}, class: 'btn btn-cyan l-margin-bottom'
                                      =link_to t('views.users.show.add_new_card'), account_cards_url, class: 'btn btn-cyan l-margin-bottom'
                                      -if @current_subscription.current_status == 'active'
                                        =link_to t('views.users.show.cancel_your_subscription_plan'), @current_subscription, method: :delete, data: {confirm: t('views.users.show.confirm_immediate_deletion') + "#{@current_subscription.next_renewal_date.to_s}"}, class: 'btn btn-red l-margin-bottom'
                                      -elsif !@current_subscription.current_status.include?('canceled')
                                        =link_to t('views.users.show.cancel_your_subscription_plan'), @current_subscription, method: :delete, data: {confirm: t('views.users.show.confirm_immediate_deletion') + "#{@current_subscription.next_renewal_date.to_s}"}


                    .row
                      .col-md-12
                        .corporate-box-item.table-box#invoices-panel.l-margin-bottom-huge
                          %h2.l-margin-bottom-big.text-center
                            =t('views.users.show.your_invoices')
                          .table-responsive
                            -@invoices = @user.invoices.paginate(page: 1, per_page: 50).where('sub_total > 0').all_in_order
                            =render partial: 'invoices/index'


                          -#unless @current_subscription.current_status.include?('cancel')
                            .col-md-4#credit-cards-panel
                              %h2
                                =t('views.users.show.your_card_details')
                              %table.table.table-striped#cards-table
                                %tbody
                                  -@user.subscription_payment_cards.all_in_order.each do |card|
                                    %tr{class: card.status == 'expired' ? 'text-muted' : ''}
                                      %td
                                        ='xxxx-xxxx-xxxx-' + card.last_4
                                        %br/
                                        =t('views.users.show.card_expires')
                                        =card.expiry_month
                                        \/
                                        =card.expiry_year
                                      %td{id: "card-#{card.last_4}"}
                                        -if card.status == 'card-live'
                                          .fake-btn.btn-cyan.btn-small
                                            =t('views.users.show.card_live')
                                        -elsif card.status == 'not-live'
                                          =link_to t('views.users.show.use_this_card'), subscription_payment_card_path(id: card.id, subscription_payment_card: {make_default_card: true}), method: :put, class: 'btn btn-purple btn-small'
                                        -elsif card.status == 'expired'
                                          =t('views.users.show.card_expired')
                              %p
                                =link_to t('views.users.show.add_new_card'), '#', data: {toggle: 'modal', target: '#new-subscription-payment-card-modal'}, class: 'btn btn-red l-margin-right-big l-padding-side-3x l-margin-top'


  -if @user.id == current_user.id
    =render partial: 'users/change_password'

  -if @current_subscription
    -if @current_subscription.current_status.include?('cancel')
      =render partial: 'users/re_subscribe'
    -else
      =render partial: 'users/upgrade_plan'
    =render partial: 'subscription_payment_cards/modal'

  -if current_user.corporate_customer?
    =render partial: 'users/company'

  =render partial: 'shared/activate_tab'
  =render partial: 'layouts/new_footer'
