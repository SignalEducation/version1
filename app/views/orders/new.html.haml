%main
  %article.bg-white
    .container
      -# %header.hero-section.px-0.pb-0
      -#   %h1.h2-hero.mb-2.text-left
      -#     Purchase
      -#   -# %p.p-hero.px-lg-12.text-left
      -#   -#   =order_short_description(@order)

      -if flash[:success] || flash[:error] || flash[:warning]
        =render partial: 'layouts/flash_messages'

      %section.pb-md-3.pb-2
        .order-checkout-section
          .container.p-0#product_purchase
            =form_for([@product, @order], html: {id: 'orders-form', class: 'payment', role: 'form'}) do |f|
              =f.hidden_field :product_id, value: @order.product.id
              =f.hidden_field :stripe_payment_method_id
              =f.hidden_field :use_paypal, value: false
              =render partial: '/layouts/error_messages', locals: {thing: @order, message: nil}

              .row
                .col-lg-6.mb-5.mb-xl-0
                  %header.mb-4
                    %h1.h2-hero.mb-2.text-left
                      Purchase
                  .row
                    .col-lg-12
                      .text-left.mb-5
                        .d-flex.py-0
                          .mr-4
                            =product_icon(@order.product)
                          %div
                            .mb-2
                              .text-left
                                %span{style: 'font-size: 1.5rem;line-height: 2rem;color: #00b67b;font-weight: 700;'}
                                  =number_in_local_currency(@order.product.price, @order.product.currency)
                            %div.h3.mb-1.text-black
                              =@order.product.name_by_type
                            %div.h5.mb-2.text-gray1
                              =order_short_description(@order)
                  .px-4{style: 'background-color: #f5f5f7;padding: 2rem;border-radius: 16px;'}
                    %p.text-left
                      =order_description(@order)

                .col-lg-6.paymentOptionBox
                  %fieldset.card.card-payments
                    %p.h3.mb-1.text-black Choose a way to pay
                    %p.mb-4 Select your preferred method of payment
                    .form-group.form-group-expandable
                      .custom-control.custom-radio
                        %input#pay-with-card.custom-control-input.style-radio{:name => "payment-options", :type => "radio", :value => 'stripe', checked: true}
                        %label.custom-control-label{:for => "pay-with-card"}
                          %span.custom-label-info
                            %span.h3.m-0
                              =image_tag('ico-card.svg', :alt => "Credit Card Icon", :class => 'logo-icon.mr-2.mr-sm-3')
                              %span Credit / Debit Card
                          %span.custom-check
                      =render partial: 'orders/order_card_form', locals: {f: f}
                    .form-group.form-group-expandable
                      .custom-control.custom-radio
                        %input#pay-with-paypal.custom-control-input.style-radio{:name => "payment-options", :type => "radio", :value => 'paypal'}
                        %label.custom-control-label{:for => "pay-with-paypal"}
                          %span.custom-label-info
                            %span.h3.m-0
                              =image_tag('ico-paypal.svg', :alt => "PayPal Logo", :class => 'logo-icon.mr-2.mr-sm-3')
                              %span PayPal
                          %span.custom-check
                      =render partial: 'orders/paypal_form', locals: {f: f}

            -# .px-4{style: 'background-color: #f5f5f7;padding: 2rem;border-radius: 16px;'}
            -#   %p.text-left
            -#     =order_description(@order)


  -if @order.product.faqs.any?
    %article.bg-white
      .container
        %header.hero-section.px-0.pb-0
          %h3.h2-hero.mb-2.text-left.text-gray2
            FAQs
        .row
          .col-sm-12
            %section.px-md-12.pb-6
              -@order.product.faqs.each do |faq|
                .faq-box.faq-quest-box
                  .faq-inner.narrow{onclick: '$(this).toggleClass("narrow"); $(this).find(".faq-answer").toggleClass("d-md-block"); $(this).find(".faq-answer-expanded").toggleClass("d-none"); $(this).find(".closed-icon").toggleClass("d-none"); $(this).find(".opened-icon").toggleClass("d-none");'}
                    .faq-title
                      .p.m-0{style: 'width: calc(100% - 24px);'}
                        =faq.question_text.html_safe
                      %i.material-icons.closed-icon{style: 'position: absolute;right: 14px;top: 14px;'} keyboard_arrow_down
                      %i.material-icons.opened-icon.d-none{style: 'position: absolute;right: 14px;top: 14px;'} keyboard_arrow_up
                    .faq-answer-expanded.d-none
                      =faq.answer_text.html_safe

:javascript

  let currencyIso = "#{@order.product.currency.iso_code}";
  let productName = "#{@order.product.name}";
  let productId = "#{@order.product.id}";
  let productPrice = "#{@order.product.price}";
  let productBody = "#{@order.exam_body_name}";
  let productBodyId = "#{@order.exam_body_id}";
  let productType = "#{@order.product&.product_type}";
  let analyticsData = {exam_body_id: productBodyId, exam_body_name: productBody, onboarding: "#{current_user&.onboarding_process&.active&.to_s}", product_id: productId, product_name: productName, product_price: productPrice, currency_iso_code: currencyIso};

  $(document).on('ready', function() {

    $('#pay-with-card').closest('.custom-control').siblings('.payment-details').slideDown();
    $('#pay-with-paypal').closest('.custom-control').siblings('.payment-details').slideUp();
    selectPaymentMethod($('.form-group-expandable').val(), false);

    $('.form-group-expandable').on('change', '.custom-control-input[type="radio"][name="payment-options"]', function() {
      $(this).closest('.card').find('.custom-control-input[type="radio"]').closest('.custom-control').siblings('.payment-details').slideUp();
      if ($(this).is(':checked')) {
        $(this).closest('.custom-control').siblings('.payment-details').slideDown();
        selectPaymentMethod($(this).val(), true);
        $('#stripe_terms_and_conditions').prop('required', true);
        $('#paypal_terms_and_conditions').prop('required', true);
      }
    });

    function selectPaymentMethod(paymentType, click) {
      if (click === true) {
        providerOptionSelect(analyticsData, paymentType);
      }
      switch(paymentType) {
        case 'paypal':
          $('#order_use_paypal').val(true);
          break;
        case 'stripe':
          $('#order_use_paypal').val(false);
          break;
        default:
          $('#order_use_paypal').val(false);
      }
    }

    function acceptedTerms(paymentType) {
      switch(paymentType) {
        case 'paypal':
          $('#stripe_terms_and_conditions').prop('required', false);
          return true;
        case 'stripe':
          $('#paypal_terms_and_conditions').prop('required', false);
          return true;
        default:
          return false;
      }
    }


    $(".spinning-loading").hide();

    var style = {
      base: {
        color: '#32325d',
        lineHeight: '18px',
        fontFamily: '"Manrope", "Helvetica Neue", Helvetica, sans-serif',
        fontSmoothing: 'antialiased',
        fontSize: '16px',
        '::placeholder': {
          color: '#aab7c4'
        }
      },
      invalid: {
        color: '#fa755a',
        iconColor: '#fa755a'
      }
    };

    var stripe = Stripe('#{ENV['LEARNSIGNAL_V3_STRIPE_PUBLIC_KEY']}');
    var elements = stripe.elements();

    var card = elements.create('card', {hidePostalCode: true, style: style});
    card.mount('#card-element');

    // Create a token when the form is submitted.
    var form = document.getElementById('orders-form');
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      //Replace submit button with spinning JS
      $('#card_submit').prop('disabled',true);
      $('#card_submit').hide();
      $('#paypal_submit').prop('disabled',true);
      $('#paypal_submit').hide();
      $(".spinner-message").html("Please wait...");
      $(".spinning-loading").show();
      if ($('#order_use_paypal').val() === 'true') {
        paypalSubmit(analyticsData);
        if(acceptedTerms('paypal')){
          document.getElementById('orders-form').submit();
        }
      } else {
        stripeSubmit(analyticsData);
        if(acceptedTerms('stripe')){
          createPaymentMethod();
        }
      }
    });

    card.addEventListener('change', function(event) {
      var displayError = document.getElementById('card-errors');
      if (event.error) {
        displayError.textContent = event.error.message;
      } else {
        displayError.textContent = '';
      }
    });

    card.on('focus', function() {
      stripeFormFocus(analyticsData);
    });

    function createPaymentMethod() {
      stripe.createPaymentMethod('card', card).then(function(result) {
        if (result.error) {
          resetForm(result.error)
        } else {
          $('#order_stripe_payment_method_id').val(result.paymentMethod.id);
          $.ajax({
            type: 'POST',
            url: "#{product_orders_path(@order.product)}",
            data: $(form).serialize(),
            dataType: 'json',
            success: function(data,status,xhr){
              if(data.status == 'pending_3d_secure'){
                handlePayment(data.client_secret, data.id)
              }else if(data.status == 'completed'){
                // Can we add a flash message ?
                window.location.replace(data['url']);
              }
            },
            error: function(xhr,status,error){
              resetForm(xhr.responseJSON.error);
            }
          });
        }
      });
    };

    function handlePayment(client_secret, order_id){
      let orderStatus = '';
      $(".spinner-message").html("Still processing...");
      stripe.handleCardAction(client_secret, card).then(function(result) {
        if (result.error) {
          resetForm(result.error);
          orderStatus = 'pending';
        } else {
          orderStatus = result['paymentIntent']['status'];
        }
          $.ajax({
            type: 'PATCH',
            url: '/orders/' + order_id,
            data: { status: orderStatus },
            dataType: 'json',
            success: function(data,status,xhr){
              if (data.status == 'completed') {
                // Can we add a flash message ?
                window.location.replace(data['url']);
              } else {
                resetForm(data);
              }
            },
            error: function(xhr,status,error){
              resetForm(xhr.responseJSON.error);
            }
        });
      });
    };

    function resetForm(error) {
      var errorElement = document.getElementById('card-errors');
      errorElement.textContent = error.message;
      $('#card_submit').prop('disabled',false);
      $('#card_submit').show();
      $('#paypal_submit').show();
      $(".spinning-loading").hide();
    }


    let banner = "#{@banner.present?.to_s}";
    let preferredExamBodyId = "#{current_user&.preferred_exam_body_id}";
    let preferredExamBody = "#{current_user&.preferred_exam_body&.name}";
    let onboarding = "#{current_user&.analytics_onboarding_valid?.to_s}";

    analytics.page('Payment', {
      preferredExamBodyId: preferredExamBodyId,
      preferredExamBody:preferredExamBody ,
      banner: banner,
      onboarding: onboarding,
      examBodyId: productBodyId,
      examBodyName: productBody,
      currency: currencyIso,
      country: "#{current_user&.country&.name}",
      productId: productId,
      productPrice: productPrice,
      productName: productName,
      productType: productType,
      paymentType: "Product"
    });
  });

