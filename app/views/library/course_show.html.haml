.bg-white
  .container
    .d-flex.flex-wrap.flex-sm-nowrap.justify-content-between.pt-5.pb-4

      -if @course.parent
        =link_to library_special_link(@course.parent), class: 'btn btn-secondary btn-sm with-arrow-sm mb-3 mb-sm-0' do
          =@course.parent.name

      -if @new_enrollment
        %a{data: {remodal: {target: 'enrollment-modal'}}, class: 'btn btn-primary btn-sm', id: 'enrol-now-button'}
          Enroll
        =render partial: 'course_enrollment_modal'


    .courses-header-section
      %h1.h1-mega.mb-4.mb-sm-3
        =@course.name

      -if @subject_course_user_log
        -total_lessons = @subject_course_user_log.subject_course.cme_count
        -completed_lessons = @subject_course_user_log.try(:count_of_cmes_completed) || 0
        -complete_percent = @subject_course_user_log.try(:percentage_complete)

        .row.row-lg
          .col-xl-8
            .pb-5
              .progress-section
                .small.mb-3
                  %span.current-step-indicator=completed_lessons
                  out of
                  %span.total-steps-indicator=total_lessons
                  steps completed
                .progress
                  .progress-bar{"aria-valuemax" => "#{complete_percent}", "aria-valuemin" => "0", "aria-valuenow" => "100", 'style'=>"width: #{complete_percent}% ;", :role => "progressbar"}

      -else
        .course-info
          =render partial: 'course_info'


      %nav.courses-nav
        %ul.nav.nav-tabs{id: 'coursesTab', role: 'tablist'}
          -@course.course_sections.all_active.all_in_order.each do |course_section|
            %li.nav-item
              %a{class: 'nav-link', id: "#{course_section.name_url}-tab", data: {toggle: 'tab'}, href: "##{course_section.name_url}", aria: {controls: "#{course_section.name_url}", selected: 'false'}, role: 'tab'}
                =course_section.name
                - if current_user && current_user.account_type == 'Trial' &&  course_section.all_content_restricted?
                  =image_tag('grey_lock_icon.png')

          %li.nav-item
            %a{href: "#exam-prep", role: 'tab', class: 'nav-link', data: {toggle: 'tab'}, aria: {controls: "exam-prep", selected: 'false'}}
              ='Exam Prep'



.bg-asphalt
  #tab-area
    .container.py-5

      .tab-content#course-tabs
        - @course.course_sections.all_active.all_in_order.each do |course_section|
          .tab-pane.fade{id: course_section.name_url, role: 'tabpanel', 'aria-labelledby': "#{course_section.name_url}-tab"}
            .ow-lg
              .col-lg-8{style: 'padding-left: 0;'}
                .mb-5.mb-xl-0


                  - course_section.course_modules.all_active.all_in_order.each_with_index do |course_module, counter|

                    .card.card-course

                      %a.btn.btn-collapse.w-100{'data-toggle': "collapse", href: "#collapse_#{course_section.name_url}_#{counter}", role: "button", 'aria-expanded': "false", 'aria-controls': "collapse_#{course_section.name_url}_#{counter}"}

                        .course-item.course-item-collapse{class: course_module.completed_for_scul(@subject_course_user_log.try(:id)) ? 'completed' : ''}
                          .course-item-icon
                            %span.icon-custom
                              %i.material-icons{aria: {hidden: "true"}}
                                - if current_user && current_user.account_type == 'Trial' && course_module.all_content_restricted?
                                  lock_outline
                                - else
                                  check

                          .course-item-title.text-truncate
                            %span.pr-sm-4
                              =course_module.name

                          .course-item-tag{style: 'margin-right: 30px;'}
                            - if course_module.children.any?
                              %span.course-tag.small
                                -if course_module.cme_count.to_i > 1
                                  =course_module.cme_count.to_s + ' ' + t('views.library.show.lessons')
                                -else
                                  =course_module.cme_count.to_s + ' ' + t('views.library.show.lesson')
                            -else
                              %span.course-tag.small.text-with-bg
                                Coming Soon


                      .collapse.card-course-inner{id: "collapse_#{course_section.name_url}_#{counter}"}
                        %ul.mb-3
                          -course_module.children.all_in_order.all_active.each do |cme|

                            %li
                              - if current_user #Logged In User
                                - permission = cme.available_to_user(current_user, @subject_course_user_log)
                                - if permission[:view]

                                  =link_to course_special_link(cme, @subject_course_user_log), class: 'course-item-link' do
                                    .course-item.course-item-static{class: @cmeuls && @cmeuls.include?(cme.id) ? (@completed_cmeuls_cme_ids && @completed_cmeuls_cme_ids.include?(cme.id) ? 'completed' : 'failed') : ''}
                                      .course-item-icon
                                        %span.icon-custom
                                          %i.material-icons{'aria-hidden': 'true'}
                                            -if cme.is_video?
                                              ondemand_video
                                            -elsif cme.is_quiz?
                                              playlist_add_check
                                            -elsif is_constructed_response?
                                              grid_on
                                            -else
                                              checked


                                      .course-item-title
                                        %span.pr-sm-4
                                          =cme.name

                                      .course-item-tag
                                        -if cme.temporary_label && !cme.temporary_label.empty?
                                          %span.course-tag.small.text-with-bg
                                          =cme.temporary_label
                                        -else
                                          %span.course-tag.small
                                            -if cme.is_video
                                              -if cme.try(:course_module_element_video).try(:duration)
                                                =humanize_time(cme.course_module_element_video.duration)
                                              -elsif cme.try(:estimated_time_in_seconds)
                                                =humanize_time(cme.try(:estimated_time_in_seconds))
                                            -elsif cme.is_quiz
                                              -if cme.number_of_questions.to_i > 1
                                                =cme.number_of_questions.to_s + ' ' +  t('views.library.show.questions')
                                              -else
                                                =cme.number_of_questions.to_s + ' ' +  'Question'


                                - else
                                  %li
                                    %a.course-item-link{data: {target: '#trial-access-restricted', toggle: 'modal'}, href: '#'}
                                      .course-item.course-item-static{class: @completed_cmeuls_cme_ids && @completed_cmeuls_cme_ids.include?(cme.id) ? 'completed' : ''}
                                        .course-item-icon
                                          %span.icon-custom
                                            %i.material-icons{'aria-hidden': 'true'}
                                              lock_outline
                                        .course-item-title
                                          %span.pr-sm-4
                                            =cme.name
                                        .course-item-tag
                                          -if cme.temporary_label && !cme.temporary_label.empty?
                                            %span.course-tag.small.text-with-bg
                                              =cme.temporary_label
                                          -else
                                            %span.course-tag.small
                                              -if cme.is_video
                                                -if cme.try(:course_module_element_video).try(:duration)
                                                  =humanize_time(cme.course_module_element_video.duration)
                                                -elsif cme.try(:estimated_time_in_seconds)
                                                  =humanize_time(cme.try(:estimated_time_in_seconds))
                                              -elsif cme.is_quiz
                                                -if cme.number_of_questions.to_i > 1
                                                  =cme.number_of_questions.to_s + ' ' +  t('views.library.show.questions')
                                                -else
                                                  =cme.number_of_questions.to_s + ' ' +  'Question'

                              - else #Anonymous User
                                -# TODO Trigger a modal explaining sign up required
                                =link_to course_special_link(cme, @subject_course_user_log), class: 'course-item-link' do
                                  .course-item.course-item-static
                                    .course-item-icon
                                      %span.icon-custom
                                        %i.material-icons{'aria-hidden': 'true'}
                                          check

                                    .course-item-title
                                      %span.pr-sm-4
                                        =cme.name

                                    .course-item-tag
                                      %span.course-tag.small.text-with-bg
                                        Coming Soon




              .col-lg-4.mb-5
                %div
                  %a.d-inline-flex.align-items-center.mb-4.w-100.link-purple-turquoise{href: "#", 'data-toggle': 'modal', 'data-target': '#ask-a-tutor-modal'}
                    .icon-custom.icon-custom-lg.mr-3
                      %i.material-icons{'aria-hidden': "true"}
                    %span.p.mb-0.font-weight-medium
                      Ask the Tutor

                  .modal.fade{id: 'ask-a-tutor-modal', tabindex: '-1', role: 'dialog', 'aria-labelledby': 'askTutorQuestion', 'aria-hidden': 'true'}
                    .modal-dialog{role: 'document'}
                      .modal-content
                        %button.btn.btn-icon.modal-close{'data-dismiss': 'modal'}
                          %span
                            Close
                          %i.material-icons.ml-1{'aria-hidden': 'true'}
                            close
                        .modal-header
                          %h3.text-red{id: 'askTutorQuestion'}
                            Ask The Tutor A Question

                        .modal-body
                          %form.py-2
                            .row
                              .col-sm-6
                                .form-group
                                  %label{for: "name"}
                                    Name
                                  %input{type: 'text', class: 'form-control', id: 'name', placeholder: 'Full Name'}

                              .col-sm-6
                                .form-group
                                  %label{for: "email"}
                                    Email
                                  %input{type: 'email', class: 'form-control', id: 'email', placeholder: 'Email Address'}

                              .col-12
                                .form-group
                                  %label{for: "question"}
                                    Question
                                  %textarea.form-control{id: "question", placeholder: 'Question', rows: '3'}

                            .pt-1
                              %button.btn.btn-primary{type: 'submit'}
                                Send The Question


                  %h3.mb-3
                    Course Resources
                  %ul.list
                    %li
                      %a{href: "#"}
                        SBR - ACCA Syllabus
                    %li
                      %a{href: "#"}
                        SBR &ndash; Useful Formulas


    -# Modals

    .modal.fade{id: 'trial-access-restricted', tabindex: '-1', role: 'dialog', 'aria-labelledby': 'trialAccessRestricted', 'aria-hidden': 'true'}
      .modal-dialog{role: 'document'}
        .modal-content
          %button.btn.btn-icon.modal-close{'data-dismiss': 'modal'}
            %span
              Close
            %i.material-icons.ml-1{'aria-hidden': 'true'}
              close
          .modal-header
            %h3.text-red{id: 'trialAccessRestricted'}
              Trial Access Restricted

          .modal-body
            %p.font-weight-medium.mb-4.text-purple
              Sorry! That content is not available on a trial account.
            %p.mb-4.text-purple
              Upgrade your account to get full access

          .modal-footer
            %a.btn.btn-primary{href: '#'}
              Upgrade

    .modal.fade{id: 'lesson-restricted-modal', tabindex: '-1', role: 'dialog', 'aria-labelledby': 'lessonRestricted', 'aria-hidden': 'true'}
      .modal-dialog{role: 'document'}
        .modal-content
          %button.btn.btn-icon.modal-close{'data-dismiss': 'modal'}
            %span
              Close
            %i.material-icons.ml-1{'aria-hidden': 'true'}
              close
          .modal-header
            %h3.text-red{id: 'lessonRestricted'}
              Lesson Restricted

          .modal-body
            %p.mb-4.text-purple
              This lesson is restricted until you complete the <b class="font-weight-medium">Test Quiz</b> lesson.


          .modal-footer
            %a.btn.btn-primary{href: '#'}
              Upgrade




- if current_user
  =render partial: 'user_exam_body_details_modal'


-if current_user && current_user.subscription_user?

  -if @new_enrollment && @subject_course_user_log && @subject_course_user_log.count_of_cmes_completed >=3
    :javascript
      $(document).ready(function() {
        var inst = $('[data-remodal-id=enrollment-modal]').remodal();
        inst.open();
      });

  -unless @exam_body_user_details || current_user.date_of_birth
    :javascript
      $(document).ready(function() {
        var inst = $('[data-remodal-id=exam-body-user-details-modal]').remodal();
        inst.open();
      });

