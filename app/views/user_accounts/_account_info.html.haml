%article.card.mb-3
  .card-body.card-body
    %h2.mb-5.text-gray2 Account Information

    -if @subscriptions.any?
      -@subscriptions.each do |subscription|
        %article.card.mb-5
          .card-body.card-body-sm
            .row
              .col-md-8
                %h3.text-gray2
                  %span.mr-1
                    =subscription.user_readable_name

                  %span.badge.badge-warning.align-middle
                    =subscription.pending_3d_secure? ? 'Action Required' : subscription.state.capitalize

                %p.mb-1
                  Subscription created on
                  %span=humanize_datetime_full(subscription.created_at)
                %p
                  Payment Type:
                  %span
                    =subscription.stripe? ? 'Credit card' : "PayPal"

              .col-md-4.text-md-right
                -if subscription.pending_3d_secure? && subscription.pending_3ds_invoice
                  =link_to show_invoice_url(subscription.pending_3ds_invoice&.sca_verification_guid) do
                    .btn.btn-secondary
                      Authenticate
                -else
                  %button.btn.btn-secondary.btn-sm.js-show-hide-details.collapsed.sub-details{"aria-controls" => "#sub-#{subscription.id}", "aria-expanded" => "false", "data-target" => "#sub-#{subscription.id}", "data-toggle" => "collapse"}

            .collapse{id: "sub-#{subscription.id}"}
              .pt-5.pb-4
                -if subscription.stripe? && @default_payment_card
                  %div
                    %h4.mb-4.text-gray2 Payment Details
                    %p
                      Card ending in
                      = succeed "." do
                        %span.font-weight-semi-bold
                          =@default_payment_card.last_4
                        ='. Expires on'
                        %span
                          =@default_payment_card.expiry_date

                    .pb-4
                      %button.btn.btn-secondary.btn-sm.mb-4{"data-target" => "#add-card-modal", "data-toggle" => "modal"} Change card

                .overflow-x.mb-5
                  %h4.text-gray2 Invoice History
                  .table-responsive
                    %table.table
                      %thead
                        %tr
                          %th Reference N.
                          %th Date Created
                          %th Amount Charged
                          %th Status
                          %th PDF
                      %tbody
                        -subscription.invoices.each do |invoice|
                          - unless invoice.status == 'Pending' && !invoice.requires_3d_secure
                            %tr
                              %td=invoice.id
                              %td=humanize_datetime(invoice.issued_at)
                              %td=number_in_local_currency(invoice.amount_due, invoice.currency)
                              %td
                                %span{class: invoice.status == 'Paid' ? 'text-success' : 'text-danger'}
                                  =invoice.status
                              %td
                                -if (subscription.pending_3d_secure? && invoice.requires_3d_secure) || invoice.status == 'Past Due'
                                  =link_to show_invoice_url(invoice.sca_verification_guid) do
                                    .btn.btn-primary.btn-xs
                                      =invoice.requires_3d_secure ? 'Authenticate' : 'Confirm Payment'
                                -else
                                  =link_to subscription_invoices_url(invoice.id, format: 'pdf'), target: '_blank' do
                                    .btn.btn-link.btn-xs
                                      View

                %div.mr-3.mb-4
                  =link_to 'View All Invoices', user_invoices_path(current_user)
                %div
                  -if subscription.can_change_plan?
                    =link_to 'Change Subscription Plan', new_subscription_plan_changes_path(subscription), class: 'btn btn-primary btn-xs', style: 'vertical-align: top;'
                  -if subscription.paused?
                    =link_to 'Reactivate Subscription', subscriptions_suspension_path(id: subscription.id), method: :delete, class: 'btn btn-secondary btn-xs', style: 'vertical-align: top;'
                  -if !subscription.cancelled?
                    =link_to 'Cancel Subscription', new_subscription_cancellation_path(subscription), class: 'btn btn-danger btn-xs', style: 'vertical-align: top;'
                  -else
                    =link_to 'Renew Subscription', subscription_checkout_special_link(subscription.subscription_plan.exam_body_id), class: 'btn btn-primary btn-xs', style: 'vertical-align: top;'



    -else
      %article.card.mb-5
        .card-body.card-body-sm
          .row
            .col-md-8
              %h3.text-gray2
                %span.mr-1
                  ='Basic Membership'

              %p.mb-1
                Account created on
                %span=humanize_datetime_full(@user.created_at)
