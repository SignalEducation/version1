// Flash quiz interactivity - CME management

function addNewFlashQuizQuestion(thing) {
  var me = $(thing),
      timeStamp = (new Date).getTime().toString(),
      theClone = $('.well.well-sm.question').first().clone();

  theClone.find('h3').text('<%= I18n.t('views.course_module_element_quizzes.form.h3.question_new') %>');
  theClone.attr('id', 'new_question_' + timeStamp);

  // just keep the first two quiz answers
  theClone.find('.quiz_answer').not(':eq(0)').not(':eq(0)').remove();

  // Update all the form fields
  var theFieldList = theClone.find('textarea, input, select');
  theFieldList.val('');
  theFieldList.each(function(index) {
    var fieldId = theFieldList.eq(index).attr('id').split('_'),
        fieldName = theFieldList.eq(index).attr('name').split('][');
    fieldId[21] = timeStamp;
    fieldName[5] = timeStamp;
    theFieldList.eq(index).attr('id', fieldId.join('_'));
    theFieldList.eq(index).attr('name', fieldName.join(']['));
  });

  theClone.find('.destroy_field').val('false');
  theClone.find('.qc-sorting-order, .answer-sorting-order').val('0');
  theClone.find('.content-type, .answer-content-type').val('text');
  theClone.find('.difficulty-level').val('easy');

  me.before(theClone);
}

$(document).on('click', '.addNewFlashQuizQuestion', function() {
  addNewFlashQuizQuestion(this);
  return false;
});

function addFlashQuizAnswer(thing) {
  var theParent = $(thing).closest('.question').find('.row.quiz_answer').parent(),
      timeStamp = (new Date).getTime().toString();
  var theClone = theParent.find('.row.quiz_answer').last().clone();
  theClone.find('.col-sm-1').text(nextLetter(theClone.find('.col-sm-1').text()));

  // rename fields
  var clonedFields = theClone.find('input, textarea, select');
  clonedFields.val(null);
  clonedFields.each(function(index) {
    var fieldName = clonedFields.eq(index).attr('name').split(']['),
        fieldId = clonedFields.eq(index).attr('id').split('_');
    fieldName[7] = timeStamp;
    fieldId[25] = timeStamp;
    clonedFields.eq(index).attr('id', fieldId.join('_')).attr('name', fieldName.join(']['));
  });

  // sorting_order hidden field
  var sortingOrderField = theClone.find('.answer-sorting-order').last();
  sortingOrderField.val( parseInt(sortingOrderField.val()) + 5);

  // content_type hidden field
  theClone.find('.answer-content-type').last().val('text');

  // sorting_orderfield
  theClone.find('.answer-sorting-order').last().val('0');

  // add it back in
  theParent.append(theClone);
}

$(document).on('click', '.addExtraFlashQuizAnswer', function() {
  addFlashQuizAnswer(this);
  return false;
});

function deleteFlashQuizAnswer(thing) {
  var theQuestion = $(thing).closest('.question'),
      theAnswer = $(thing).closest('.quiz_answer');

  // ensure there are at least three answers in this question - otherwise, don't delete
  if (theQuestion.find('.quiz_answer').length > 2) {
    var confirmation = confirm("<%= I18n.t('views.general.delete_confirmation') %>");
    if (confirmation) {
      if (theAnswer.find('.answer-id').val() == '') {
        theAnswer.remove();
      } else {
        theAnswer.find('.answer-destroy').val('1');
        theAnswer.hide();
      }
    }
  } else {
    alert("Sorry, you can't delete this answer - there must be at least two answers for each question.");
  }
}

$(document).on('click', '.deleteFlashAnswer', function() {
  deleteFlashQuizAnswer(this);
  return false;
});

function deleteFlashQuizQuestion(thing) {
  var theQuestion = $(thing).closest('.question');
  if (theQuestion.parent().find('.question').length > 1) {
    var confirmation = confirm("<%= I18n.t('views.general.delete_confirmation') %>");
    if (confirmation) {
      if (theQuestion.find('.question_id').val() == '') {
        theQuestion.remove();
      } else {
        theQuestion.find('.destroy_field').val('1');
        theQuestion.hide();
      }
    }
  } else {
    alert("Sorry, you can't delete the only question in a stack");
  }
}

$(document).on('click', '.deleteFlashQuizQuestion', function() {
  deleteFlashQuizQuestion(this);
  return false;
});

function nextLetter(theLetter) {
  return String.fromCharCode(theLetter.trim().charCodeAt() + 1);
}

