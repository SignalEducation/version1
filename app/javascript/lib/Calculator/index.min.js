function loadCalc(){const calcMain=document.getElementById("calc-main");if(null!==calcMain){const calcSS3=document.querySelector(".calc-main"),display=calcSS3.querySelector(".calc-display span"),radDeg=calcSS3.querySelector(".calc-rad"),smallerButton=calcSS3.querySelector(".calc-smaller"),hold=calcSS3.querySelector(".calc-hold"),lnButton=calcSS3.querySelector(".calc-ln"),helpButton=calcSS3.querySelector(".calc-info"),secondKeySet=[].slice.call(calcSS3.querySelector(".calc-left").children,12,20);let pressedKey,frozenKey,secondActive=!1,bracketKey,brackets=0;const calculator=[];let deg=!1,memory=0,resBuffer="0",bigger=!1,ln=0,buffStr=[];const sav=["secondActive","deg","memory","buffStr","resBuffer"],keyBoard={},secondLayer=[["sin","cos","tan","ln","sinh","cosh","tanh","e<sup>x</sup>"],["sin<sup>-1</sup>","cos<sup>-1</sup>","tan<sup>-1</sup>","log<sub>2</sub>","sinh<sup>-1</sup>","cosh<sup>-1</sup>","tanh<sup>-1</sup>","2<sup>x</sup>"]],Calculator=function(){this.stack=[],this.num=0,this.res=0,this.buff=[!1,!1],this.curr=!0,this.rank={"=":0,"+":1,"-":1,"/":2,"*":2,yx:3,"x√y":3,EE:3}};Calculator.prototype.calc=function(key,val){const{rank:rank}=this;return"%"===key?(this.curr="funk",`${this.stack[0]?this.stack[this.num-1][0]/100*val:val/100}`):(key=key.replace("×","*").replace("÷","/").replace("–","-"),"="!==key?this.buff[1]=key:!1===this.buff[0]&&(this.buff[0]=val),"="===key&&!this.stack[0]&&this.curr&&this.buff[1]?`${"yx"===this.buff[1]?Math.pow(val,this.buff[0]):"x√y"===this.buff[1]?Math.pow(val,1/this.buff[0]):"EE"===[1]?val*Math.pow(10,this.buff[0]):eval(`(${val})${this.buff[1]}(${this.buff[0]})`)}`:this.stack[0]||"="===key?this.stack[0]&&this.curr&&"funk"!==this.curr&&"="!==key?(this.stack[this.num-1]=[val,key],`${val}`):this.stack[0]?(rank[key]<=rank[this.stack[this.num-1][1]]&&(this.stack[this.num-1]=["yx"===this.stack[this.num-1][1]?Math.pow(this.stack[this.num-1][0],val):"x√y"===this.stack[this.num-1][1]?Math.pow(this.stack[this.num-1][0],1/val):"EE"===this.stack[this.num-1][1]?this.stack[this.num-1][0]*Math.pow(10,val):eval(`(${this.stack[this.num-1][0]})${this.stack[this.num-1][1]}(${val})`),key]),rank[key]>rank[this.stack[this.num-1][1]]?this.stack[this.num++]=[val,key]:this.stack[this.num-2]&&rank[key]<=rank[this.stack[this.num-2][1]]&&this.calc(key,this.stack[--this.num][0]),this.res=`${this.stack[this.num-1]?this.stack[this.num-1][0]:this.res}`,"="===key&&this.init("AX"),this.curr=!0,this.res):`${val}`:(this.buff[0]=!1,this.stack[this.num++]=[val,key],this.curr=!0,`${val}`))},Calculator.prototype.init=function(e){return e.match(/A/)&&(this.stack=[],this.num=0),"AC"===e&&(this.buff=[!1,!1]),"0"};for(let e=2;e--;)for(var l=calcSS3.children[e+1],m=l.children,n=m.length;n--;)keyBoard[l.children[n].textContent.replace(/\s*/g,"")]=l.children[n];keyBoard.C=keyBoard.AC,keyBoard.Rad=keyBoard.Deg;for(var m=secondLayer[0],n=m.length;n--;)keyBoard[secondLayer[1][n].replace(/<\/*\w+>/g,"")]=keyBoard[m[n]];function keyDown(e,t){const a=e||window.event,r=(t||getTargetKey(a.target)).textContent.replace(/\s*/g,""),c=keyBoard[r];return c&&(keyUp(),pressedKey=c,c.className+=" calc-press"),!1}function getTargetKey(e){for(;e!==calcSS3&&e.parentNode&&e.parentNode.style&&!/calc-(?:left|right)/.test(e.parentNode.className);)e=e.parentNode;return e}function keyUp(){pressedKey&&pressedKey!==secondActive&&(pressedKey.className=pressedKey.className.replace(" calc-press",""),pressedKey=null)}function freezeKey(e,t){const a=t&&2===t?e:frozenKey;return a&&(a.className=a.className.replace(" calc-active","")),t||(e.className+=" calc-active",frozenKey=e),a}function saveState(){for(let n=sav.length;n--;)localStorage[sav[n]]=eval(sav[n])}function toggleOptions(e){helpButton.active=!!e}function toggleCalc(e){const t=calcSS3.className;e&&(bigger=!bigger),localStorage.bigger=bigger,calcSS3.className=bigger?t.replace(" calc-small",""):`${t} calc-small`,smallerButton.firstChild.data=bigger?">":"<",render(resBuffer)}function switchGrouping(e){e&&(ln=++ln>3?0:ln),lnButton.firstChild.data=ln?1===ln?",":2===ln?",.":".,":".",render(resBuffer),localStorage.ln=ln}function render(e,t){const a=/(\d+)(\d{3})/,r=e.match(/\./);let c;const s=Math.abs(+e);let n=45;const l=display.style,o=display.parentNode.style;if(e.match(/NaN|Inf|Error/))c="Error";else{for(resBuffer=e,s>=1e16&&(e=`${(+e).toExponential(13)}`),bigger||t&&"+/–"!==t||0===s||(e=(+e).toPrecision(9)),(c=`${e}`.split("."))[1]&&(c[2]=c[1].split("e"),c[2][1]&&(c[1]=c[2][0]),t&&"+/–"!==t||(c[1]=`${(+`1.${c[1]}`).toPrecision(bigger?16:c[2][1]?7:9)}`,c[1]>=2&&(c[0]=`${+c[0]+1}`),c[1]=c[1].substr(2).replace(/0+$/,"")));a.test(c[0]);)c[0]=c[0].replace(a,"$1 $2");c=c[0]+(c[1]||r?`.${c[1]}`:"").replace(".undefined","").replace(t?"":/\.$/,"")+(c[2]&&c[2][1]?`e${c[2][1]}`:"")}for(ln&&(c=c.replace(/\./g,"#").replace(/\s/g,1===ln?" ":2===ln?",":".").replace(/#/g,2===ln?".":",")),display.firstChild.data=c,l.fontSize="45px",o.lineHeight="61px";display.offsetWidth>display.parentNode.offsetWidth-(bigger?40:30);)l.fontSize=`${n--}px`,o.lineHeight=`${n+18}px`}function doKey(e,t){const a=keyBoard[e];if("2nd"===e){secondActive=!secondActive||null,a.className=secondActive?"calc-press calc-second":"";for(let e=secondKeySet.length;e--;)secondKeySet[e].children[0].innerHTML=secondLayer[secondActive?1:0][e]}else e.match(/^[+|–|÷|×|yx|x√y|E]+$/)&&"√"!==e?freezeKey(a):e.match(/^[\d|\.|π]$/)?(freezeKey(a,!0),keyBoard.AC.children[0].firstChild.data="C"):"C"===e?(a.children[0].firstChild.data="AC",frozenKey&&freezeKey(frozenKey)):e.match(/AC|=/)?(bracketKey&&freezeKey(bracketKey,2),freezeKey(a,!0),frozenKey=null):e.match(/Deg|Rad/)?(radDeg.firstChild.data=deg?"Rad":"Deg",a.children[0].firstChild.data=deg?"Deg":"Rad",deg=!deg):"("===e?freezeKey(bracketKey=a,2).className+=" calc-active":")"===e&&1===brackets&&bracketKey?freezeKey(bracketKey,2):e.match(/^mr$/)&&memory&&(keyBoard.AC.children[0].firstChild.data="C");evalKey(e),t||keyUp(),e.match(/^m[c|+|-]/)&&(freezeKey(keyBoard.mr,2).className+=memory?" calc-active":"")}function evalKey(e){let t,a=`${resBuffer.replace(/\s/g,"").replace(/Error|∞|-∞/,"0")}`,r=Math.PI;if(e.match(/2nd|Deg|Rad|m/)||(buffStr.push(e),("="===buffStr[buffStr.length-2]&&"="!==e&&calculator[brackets].curr||"AC"===e)&&(buffStr=[e])),t=buffStr[buffStr.length-2],e.match(/^[\d|\.]$/)||"+/–"===e)(calculator[brackets].curr&&"+/–"!==e||"+/–"===e&&t&&t.match(/^[+|–|÷|×|yx|x√y|E|^C]+$/))&&(a="0",calculator[brackets].curr=!1),(Math.abs(+(a+e))>(bigger?1e15:1e9)||a.replace(/^-/,"").length>15||a.replace("-","").replace(/\./g,"").length>(bigger?14:8)||a.match(/\.|\e\+/)&&"."===e)&&"+/–"!==e?buffStr.pop():"+/–"===e?render(a.replace(/e[\+|\-]/,"").match("-")?a.replace(/^-/,""):`-${a}`,"+/–"):render((a+e).replace(/^(-)*?0(\d)$/,"$1$2"),!0);else if(e.match(/^C|AC/))render(calculator[brackets].init(e)),hold.textContent="";else if(e.match(/^[+|–|÷|×|-|\/|*|yx|x√y|%|E]+$/)&&"√"!==e)render(calculator[brackets].calc(e,a));else switch(brackets>-1&&(calculator[brackets].curr="funk"),e){case"=":for(;brackets>-1;)render(a=calculator[brackets--].calc("=",a));calculator[brackets=0].curr=!0;break;case"(":calculator[++brackets]=new Calculator,calculator[brackets].curr=!0;break;case")":brackets&&render(calculator[brackets--].calc("=",a)),brackets>-1&&(calculator[brackets].curr=!1);break;case"mc":memory=0;break;case"m+":memory+=+a;break;case"m-":memory-=+a;break;case"mr":render(`${memory}`);break;case"1/x":render(`${1/a}`);break;case"x2":render(`${Math.pow(a,2)}`);break;case"x3":render(`${Math.pow(a,3)}`);break;case"x!":render(`${function e(t){return t<0||t>170?NaN:t<=1?1:t*e(t-1)}(Math.round(+a))}`);break;case"√":render(`${Math.sqrt(a)}`);break;case"log":render(`${Math.log(a)/Math.log(10)}`);break;case"sin":render(deg||Math.abs(a)!==r?`${Math.sin(a*(deg?r/180:1))}`:"0");break;case"sin-1":render(`${Math.asin(a)*(deg?180/r:1)}`);break;case"cos":render(`${Math.cos(a*(deg?r/180:1))}`);break;case"cos-1":render(`${Math.acos(a)*(deg?180/r:1)}`);break;case"tan":render(deg||Math.abs(a)!==r?`${Math.tan(a*(deg?r/180:1))}`:"0");break;case"tan-1":render(`${Math.atan(a)*(deg?180/r:1)}`);break;case"ln":render(`${Math.log(a)}`);break;case"log2":render(`${Math.log(a)/Math.log(2)}`);break;case"sinh":render(`${(Math.pow(Math.E,a)-Math.pow(Math.E,-a))/2}`);break;case"sinh-1":render(`${Math.log(+a+Math.sqrt(1+Math.pow(a,2)))}`);break;case"cosh":render(`${(Math.pow(Math.E,a)+Math.pow(Math.E,-a))/2}`);break;case"cosh-1":render(`${2*Math.log(Math.sqrt((+a+1)/2)+Math.sqrt((+a-1)/2))}`);break;case"tanh":c=Math.pow(Math.E,a),s=Math.pow(Math.E,-a),render(`${(c-s)/(c+s)}`);break;case"tanh-1":render(`${(Math.log(+a+1)-Math.log(1-a))/2}`);break;case"ex":render(`${Math.exp(a)}`);break;case"2x":render(`${Math.pow(2,a)}`);break;case"π":render(`${r}`);break;case"Rand":render(`${Math.random()}`)}var c,s}keyBoard["2x"]=keyBoard.ex,calculator[0]=new Calculator,calcSS3.onmousedown=function(e){return keyDown(e),!!pressedKey&&(document.addEventListener("mouseout",keyUp,!1),document.addEventListener("mouseover",keyDown,!1),!1)},document.addEventListener("mouseup",function(e){const t=e||window.event,a=getTargetKey(t.target).textContent.replace(/\s*/g,""),r=keyBoard[a];if(t.target===smallerButton&&toggleCalc(!0),t.target===lnButton&&switchGrouping(!0),t.target!==lnButton&&toggleOptions(),document.removeEventListener("mouseout",keyUp,!1),document.removeEventListener("mouseover",keyDown,!1),!pressedKey)return!1;r&&(doKey(a),saveState())},!1),display.parentElement.addEventListener("dblclick",function(){helpButton.active||toggleCalc(!0)},!1),helpButton.addEventListener("mouseover",function(){toggleOptions(!0)},!1)}else setTimeout(loadCalc,2e3)}window.onload=function(){loadCalc()};
